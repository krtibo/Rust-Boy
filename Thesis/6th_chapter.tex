\chapter{A program használata, tesztelés, és az elért eredmények}

Az elõzõ fejezetekben taglalt implementációs rész lezárult, ebben a fejezetben a kész emulátorról lesz szó -- annak használatáról, a futtatott tesztekrõl, és azok eredményeirõl. A fejezet végén egy összefoglaló részben a fejlesztés egészét számba véve fogom taglalni azt, hogy mi maradt ki, mit lehetett volna jobban csinálni, mi sikerült jól, vagy éppen kevésbé jól.

\section{A program használata, függõségek}

A program fejlesztéséhez Linux rendszert használtam, ennek ellenére viszont a program maga multiplatform -- Windows rendszeren is lefordítható és futtatható a megfelelõ fordító \textit{targetet} megadva. Az operációs rendszert tehát nem tekinthetjük függõségnek. A program fejlesztéséhez összesen két \textit{libraryt} használtam fel, a már taglalt \texttt{minifb} és \texttt{rand} könyv\-tá\-ra\-kat. \\
A \texttt{minifb} könyvtár esetén elmondható, hogy sajnos nem tartalmaz olyan megoldást, amellyel programkód segítségével be lehetne zárni egy ablakot. Ennek az lett a kö\-vet\-kez\-mé\-nye, hogy az eredeti terv szerint kapcsolókkal be-, és kikapcsolható \textit{debugger} és \textit{memory map} ablakokat ki kellett vennem a \textit{release} változatból, így azok nem elérhetõek. \\
A program használata nagyon egyszerû, parancssorból indítható. A parancssori indításhoz két paramétert kell megadni: 

\begin{itemize}
  \item az indítandó játék ROM-jának elérési útvonalát,
  \item a program skálázásának mértékét: ez lehet \texttt{X1}, \texttt{X2}, és \texttt{X4}.
\end{itemize}

\noindent Az emulátor mellé kell helyezni a Boot ROM-ot, enélkül a játékok ROM-jai nem fut\-tat\-ha\-tók. Egy példa az emulátor indítására:

\begin{minted}{bash}
                ./rust_boy rom/mario.gb -X4
\end{minted}

\noindent A skálázás segítségével nagyítani lehet az eredetileg 160$\times$144-es felbontáson, hogy jobban látszódjon mi történik az emulátoron -- az \texttt{X2}-es beállítással ez 320$\times$288-as, az \texttt{X4}-es beállítással pedig 640$\times$576 pixeles nagyságú lesz a renderelt kép. A nagyítás \textit{Nearest Neighbor} interpolációval történik, így nem mosódnak el a pixelek, minden tûéles marad. \\
A program indítását követõen elõször az eredeti hardverhez hasonlóan beúszik a Nintendo logó, majd betöltõdik a játék ROM-ja, ezzel egyidõben pedig az emulátor ablakának címsorában megjelenik a betöltött játék címe (amelyet a ROM \textit{headerjébõl} olvas ki a program).

\section{Tesztelés}

A Game Boy emulátorok tesztelésére többféle módszer létezik. Írhatunk saját magunk teszteket, amelyek a programmal együttmûködve ellenõrzik az egyes mûveletek utáni állapotot, viszont ebben az esetben az összes CPU mûveletet lefedõ teszteset halmazt kell írni, ami nagyon idõigényes. Természetesen emellé még külön oda kell figyelni az \textit{edge-casekre}, amik ritkán fordulnak ugyan elõ, de hektikus viselkedést idézhetnek elõ -- így már elsó hangon is minimum ezer tesztesetrõl beszélünk, ami borzasztó sok, fõleg egy fejlesztõre. Így hát maradnak az alternatív megoldások -- szerencsére léteznek a közösség által elfogadott, szinte tökélyre fejlesztett teszt romok, amelyek minden utasítást, regiszter viselkedést lefednek. Ezek nem csak azért jók, mert nem kell mi magunknak külön tesz\-te\-ket írni, hanem mert az egyes emulátorok összehasonlíthatóvá válnak, akár teljesítmény, vagy emuláció pontosság szempontjából is. Ilyen, nagyrészt a közösség által használt ROM kollekció a Blargg féle teszt ROM csomag. Az alábbi, \ref{fig:tests}-es ábrán láthatóak az egyes teszt ROM-ok eredményei. Fontos megjegyezni hogy egy ROM több tesztesetet is tartalmaz, a logikailag egybe tartozó utasítások vannak egy ROM-ba allokálva.

\begin{figure}[h!]%
    %\centering
    \subfloat[\textit{Speciális utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/01.eps}}
    \quad
    \subfloat[\textit{Megszakítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/02.eps}}
    \quad
    \subfloat[\texttt{SP}, \texttt{HL} \textit{utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/03.eps}}
    \quad
    \subfloat[\textit{Byte utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/04.eps}}
    \quad
    \subfloat[\textit{2 bájtos aritmetikai utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/05.eps}}
    \quad
    \subfloat[\textit{Betöltõ utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/06.eps}}
    \quad
    \subfloat[\textit{Eljárás utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/07.eps}}
    \quad
    \subfloat[\textit{Egyéb utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/08.eps}}
    \quad
    \subfloat[\textit{Regiszterek közötti utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/09.eps}}
    \quad
    \subfloat[\textit{Bitmûveleti u\-ta\-sí\-tá\-sok}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/10.eps}}
    \quad
    \subfloat[\textit{Utasítások me\-mó\-ri\-a\-cí\-mek\-kel}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/11.eps}}
    \caption{\textit{A Blargg-féle ROM tesztek és eredményeik}}
    \label{fig:tests}
\end{figure}

\noindent A ROM-ok futásuk során minden sikertelen teszt esetet kiírnak, néhol több, de inkább kevesebb hiba információval szolgálva. Az természetesen vitén felül áll, hogy ezekkel a ROM-okkal párhuzamosan ajánlott fejleszteni az emulátort, hiszen megmentheti a prog\-ra\-mo\-zót a késõbbi fejfájásoktól, amit az egyes utasításokban rejlõ bugok okoznak. Sikeres esetben a \textit{Passed} felirat jelenik meg a képernyõn. Mint a fenti ábra alapján is látszik, 11 darab teszt ROM van, összesen több száz teszt esettel. Az általam fejlesztett emulátor az összes elérhetõ Blargg-féle teszt ROM-ot sikeres eredménnyel zárja, egyetlen kivétellel -- a megszakításokkal kapcsolatos \texttt{02-interrupts} nevû teszt 4. teszt esetét nem tudja sikeresen elvégezni. Az emellé kapott hibaüzenet nem sokat segít -- a "\textit{Timer doesn't work}" üzenet egyszerûen nem igaz, az idõzítõk mûködnek. Sok kutatás után arra a kö\-vet\-kez\-te\-tés\-re jutottam, hogy a megszakítások idõzítése valószínûleg nem tökéletes, sok emulátor megbukik ezen a teszten, szigorú feltételeknek kell eleget tenni. Mivel sem magamtól, sem pedig az interneten nem találtam megoldást erre, így nem sikerült ezt kijavítani. Az egyes teszt ROM-ok által tartalmazott utasításokat a következõ felsorolás foglalja össze:

\begin{itemize}
  \item \textbf{\texttt{01-special:}} ez a teszt csomag a speciális ugrás és betöltõ mûveleteket, valamint a \mintinline{asm}{DAA} mûveletet ellenõrzi -- ez utóbbit az az \texttt{A} regiszter összes lehetséges állapotában és a \textit{flagek} minden lehetséges permutációjával. 
  \item \textbf{\texttt{02-interrupts:}} ezek a tesztek az \mintinline{asm}{EI}, \mintinline{asm}{DI} megszakítás engedélyezõ, illetve tiltó mûveleteket, a \mintinline{asm}{HALT} mûveletet, és a megszakítások idõzítéseit vizsgálják.
  \item \textbf{\texttt{03-op sp,hl:}} ez a teszt ROM olyan teszt eseteket tartalmaz, amelyek azon mûveleteket ellenõrzik, amelyek esetén vagy a \textit{Stack Pointer}, vagy a \textit{Stack Pointer} és a \texttt{HL} regiszter az operandus. Ezek lehetnek aritmatikai vagy betöltõ mûveletek is.
  \item \textbf{\texttt{04-op r,imm:}} ez a teszt olyan mûveletek helyességét ellenõrzi, amelyek e\-se\-té\-ben a második operandus egy konkrét bájt (nem memóriacímként megadott hivatkozás).
  \item \textbf{\texttt{05-op rp:}} ez a teszt csomag azokat a mûveleteket ellenõrzi, amelyek esetében 16 bites értékeken, azaz a \texttt{BC}, \texttt{DE}, \texttt{HL} regiszter párokon végzünk feladatokat. 
  \item \textbf{\texttt{06-ld r,r:}} ezzel a teszttel az összes -- regiszterek közti -- \mintinline{asm}{LD} mûveletet tudjuk ellenõrizni.
  \item \textbf{\texttt{07-jr,jp,call,ret,rst:}} ennek a teszthalmaznak a neve sokat elárul: eljárás utasításokat, vagyis ugrásokat, és feltételes ugrásokat, eljáráshívásokat, visszaté\-ré\-se\-ket, és a \textit{reset} mûveleteket ellenõrzi.
  \item \textbf{\texttt{08-misc instrs:}} ez a teszt csomag azon mûveletek helyességét ellenõrzi, amelyek semelyik más kategóriába sem fértek be: a \mintinline{asm}{PUSH}-t és \mintinline{asm}{POP}-ot, valamint a speciális betöltõ utasításokat.
  \item \textbf{\texttt{09-op r,r:}} ezzel a teszttel fõként az aritmetikai mûveleteket lehet el\-le\-nõ\-riz\-ni: az összes összeadás, kivonás, logikai mûvelet, forgatás, csere, eltolás variációra tartalmaz teszt esetet.
  \item \textbf{\texttt{10-bit ops:}} ez a teszt az összes bitmûveletet ellenõrzi: a bit lekéréseket, \textit{resetet}, \textit{setet} egyaránt.
  \item \textbf{\texttt{11-op a,(hl):}} ez a teszt ROM olyan teszt eseteket futtat le, amelyek azokat a processzor mûveleteket vizsgálják, ahol valamelyik operandus egy két bájtos (egy regiszterpárból kombinált) memóriacím, amely címen lévõ értékkel szeretnénk dolgozni.
\end{itemize}

\section{Az elért eredmények, összegzés}